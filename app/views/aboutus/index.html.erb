
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  .aboutus-image {
    object-fit: contain;
    border-radius: 12px;
    width: 100%;
    height: auto;
  }
  .text-limited {
    overflow: hidden;
  }
</style>

<div class="container-fluid background-color">
  <div class="py-md-5 py-4">
    <h4 class="text-center text-white caudex-bold p-0 m-0">ABOUT</h4>
  </div>

  <% @aboutus.each do |about| %>
    <% 
      plain_text = strip_tags(about.text.body.to_s)
      words = plain_text.split(/\s+/)
      # initially show ALL
      first_words = words.join(" ")
    %>
    <div class="row px-md-5 mt-4 align-items-start">
      <!-- IMAGE -->
      <div class="col-lg-6 mb-4 mb-lg-0">
        <% if about.image&.attached? %>
          <%= image_tag about.image, alt: "About Image", class: "img-fluid aboutus-image", id: "about-image-#{about.id}" %>
        <% end %>
      </div>

      <!-- TEXT limited to image height -->
      <div class="col-lg-6 text-white d-flex align-items-start">
        <div id="about-text-<%= about.id %>" class="text-limited">
          <%= about.text.body.to_s.html_safe %>
        </div>
      </div>
    </div>

    <!-- extra block for showing overflow text -->
    <div class="row px-md-5 mt-2">
      <div class="col-12 text-white">
        <div id="overflow-text-<%= about.id %>"></div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function() {
        const img = document.getElementById("about-image-<%= about.id %>");
        const textBlock = document.getElementById("about-text-<%= about.id %>");
        const overflowBlock = document.getElementById("overflow-text-<%= about.id %>");

        function splitText() {
          const imgHeight = img.clientHeight;
          textBlock.style.maxHeight = imgHeight + "px";

          // after forcing maxHeight, get hidden text
          // clone for measurement
          const clone = textBlock.cloneNode(true);
          clone.style.position = "absolute";
          clone.style.visibility = "hidden";
          clone.style.maxHeight = "none";
          document.body.appendChild(clone);

          if (clone.scrollHeight > imgHeight) {
            // get visible content
            textBlock.style.overflow = "hidden";
            // get hidden content (in theory)
            overflowBlock.innerHTML = textBlock.innerHTML;
          }
          document.body.removeChild(clone);
        }

        if (img.complete) {
          splitText();
        } else {
          img.addEventListener("load", splitText);
        }
      });
    </script>
  <% end %>
</div>
